<template>
	<view class="user" :class="$store.state.AppStyle">
		<view class="header" :style="[{height:CustomBar + 'px'}]">
			<view class="cu-bar bg-white" :style="{'height': CustomBar + 'px','padding-top':StatusBar + 'px'}">
				<view class="action" @tap="back">
					<text class="cuIcon-back"></text>
				</view>
				<view class="content text-bold" :style="[{top:StatusBar + 'px'}]">
					个人设置
				</view>
				<!--  #ifdef H5 || APP-PLUS -->
				<view class="action" @tap="userEdit">
					<button class="cu-btn round bg-blue">保存</button>
				</view>
				<!--  #endif -->
			</view>
		</view>
		<view :style="[{padding:NavBar + 'px 10px 0px 10px'}]"></view>

		<form>
			<view class="user-edit-header margin-top">
				<image :src="avatar"></image>
				<!--  #ifdef H5 || APP-PLUS -->
				<!-- <text class="cu-btn bg-blue radius" @tap="showModal" data-target="DialogModal1">设置头像</text> -->
				<text class="cu-btn bg-gradual-blue radius" @tap="toAvatar">设置头像</text>
				<!--  #endif -->
				<!-- #ifdef MP-WEIXIN -->
				<button class="cu-btn bg-gradual-blue radius" open-type="chooseAvatar" @chooseavatar="avatarUpload"></button>
				<!-- #endif -->
			</view>
			<view class="cu-form-group">
				<view class="title">用户名</view>
				<input name="input" disabled="disabled" :value="name"></input>
			</view>
			<view class="cu-form-group margin-top">
				<view class="title">昵称</view>
				<input placeholder="请输入昵称" name="input" v-model="screenName"></input>
			</view>
			<view class="cu-form-group">
				<view class="title">邮箱</view>
				<input placeholder="未设置" disabled="disabled" name="input" :value="mail"></input>
				<view class="text-blue" @tap="toEmail">修改</view>
			</view>
			<view class="cu-form-group">
				<view class="title">网址</view>
				<input placeholder="请输入网址" name="input" v-model="url"></input>
			</view>
			<view class="cu-form-group align-start">
				<view class="title">个人简介</view>
				<textarea v-model="introduce" placeholder="输入个人简介"></textarea>
			</view>
			<view class="cu-form-group margin-top">
				<view class="title">密码</view>
				<input placeholder="请输入密码,不填则不修改" v-model="password" name="input"></input>
			</view>
			<view class="cu-form-group">
				<view class="title">确认密码</view>
				<input placeholder="请再次输入密码" v-model="repassword" name="input"></input>
			</view>
		</form>
		<!--  #ifdef H5 || APP-PLUS -->
		<view class="cu-list menu">
			<view class="cu-item margin-top" @tap="toBg">
				<view class="content">
					<text>主页背景图</text>
				</view>
				<view class="action">
					<text class="cuIcon-right"></text>
				</view>
			</view>
			<view class="cu-item" @tap="toBind">
				<view class="content">
					<text>社会化登陆绑定</text>
				</view>
				<view class="action">
					<text class="cuIcon-right"></text>
				</view>
			</view>
			<view class="cu-item" @tap="toAddress">
				<view class="content">
					<text>收货地址设置</text>
				</view>
				<view class="action">
					<text class="cuIcon-right"></text>
				</view>
			</view>
			<view class="cu-item" @tap="toPay">
				<view class="content">
					<text>账户设置</text>
				</view>
				<view class="action">
					<text class="cuIcon-right"></text>
				</view>
			</view>
		</view>
		<!--  #endif -->
		<view class="cu-modal" :class="modalName=='DialogModal1'?'show':''">
			<view class="cu-dialog">
				<view class="cu-bar bg-white justify-end">
					<view class="content">设置头像</view>
					<view class="action" @tap="hideModal">
						<text class="cuIcon-close text-red"></text>
					</view>
				</view>
				<view class="padding-xl text-left">
					<view>
						Gravatar是全球最大的头像库，属于Wordpress旗下。它广泛应用于国内外各类网站和程序，包括知名的Github。在Gravatar通过您的邮箱注册用户，并设置头像后，您在所有支持Gravatar的网站使用邮箱，都会显示您的头像。
					</view>
					<view>或者，您可以将将邮箱设置成QQ邮箱，将自动获取您的QQ头像。</view>
				</view>
				<view class="cu-bar bg-white justify-end">
					<view class="action">
						<button class="cu-btn bg-green margin-left" @tap="toGravatar">前往Gravatar</button>

					</view>
				</view>
			</view>
		</view>
		<!--  #ifdef MP -->
		<view class="post-update bg-blue" @tap="userEdit">
			<text class="cuIcon-upload"></text>
		</view>
		<!--  #endif -->
	</view>
</template>

<script>
	import {
		localStorage
	} from '../../js_sdk/mp-storage/mp-storage/index.js'
	// #ifdef H5 || APP-PLUS 
	import {
		pathToBase64,
		base64ToPath
	} from '../../js_sdk/mmmm-image-tools/index.js'
	// #endif
	export default {
		data() {
			return {
				StatusBar: this.StatusBar,
				CustomBar: this.CustomBar,
				NavBar: this.StatusBar + this.CustomBar,
				AppStyle: this.$store.state.AppStyle,

				uid: 0,
				name: '',
				screenName: '',
				password: '',
				repassword: '',
				mail: '',
				phone: "",
				url: '',
				avatar: "",
				avatarNew: "",
				introduce: "",

				modalName: null,

				token: '',
				styleIndex: "",
			}
		},
		onPullDownRefresh() {
			var that = this;

		},
		onShow() {
			var that = this;
			// #ifdef APP-PLUS

			//plus.navigator.setStatusBarStyle("dark")
			// #endif

			that.userStatus();

			if (localStorage.getItem('toAvatar')) {
				var toAvatar = JSON.parse(localStorage.getItem('toAvatar'));
				that.avatarUpload(toAvatar.dataUrl);
			} else {
				console.log("没有头像缓存")
			}

		},
		onLoad() {
			var that = this;
			// #ifdef APP-PLUS || MP
			that.NavBar = this.CustomBar;
			// #endif
		},
		methods: {
			back() {
				uni.navigateBack({
					delta: 1
				});
			},
			showModal(e) {
				this.modalName = e.currentTarget.dataset.target
			},
			hideModal(e) {
				this.modalName = null
			},
			validatePassword(password) {
				const regex =
					/^(?=.*[A-Za-z])(?=.*\d)(?=.*[`~!@#$%^&*()_+<>?:"{},.\/\\;'[\]])[A-Za-z\d`~!@#$%^&*()_+<>?:"{},.\/\\;'[\]]{8,}$/;
				return regex.test(password);
			},

			userStatus() {
				var that = this;
				var token = "";
				if (localStorage.getItem('userinfo')) {
					var userInfo = JSON.parse(localStorage.getItem('userinfo'));
					token = userInfo.token;
				}
				that.$Net.request({

					url: that.$API.userStatus(),
					data: {
						"token": token
					},
					header: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					method: "get",
					dataType: 'json',
					success: function(res) {
						if (res.data.code == 1) {
							that.uid = res.data.data.uid;
							that.screenName = res.data.data.screenName;
							that.name = res.data.data.name;
							that.mail = res.data.data.mail;
							that.url = res.data.data.url;
							that.token = res.data.data.token;
							that.avatar = res.data.data.avatar;
							that.introduce = res.data.data.introduce;
							that.phone = res.data.data.phone;
							if (localStorage.getItem('userinfo')) {

								var userInfo = JSON.parse(localStorage.getItem('userinfo'));
								if (userInfo.screenName) {
									that.screenName = userInfo.screenName;
								} else {
									that.screenName = userInfo.name;
								}
								if (res.data.data.customize) {
									userInfo.customize = res.data.data.customize;
								}
								if (res.data.data.lv) {
									userInfo.lv = res.data.data.lv;
								}
								if (res.data.data.isvip) {
									userInfo.isvip = res.data.data.isvip;
								}
								if (res.data.data.vip) {
									userInfo.vip = res.data.data.vip;
								}
								if (res.data.data.experience) {
									userInfo.experience = res.data.data.experience;
								}
								localStorage.setItem('userinfo', JSON.stringify(userInfo));
								// if(res.data.data.avatar){
								// 	that.userInfo = res.data.data.avatar;
								// }

							}

						}
					},
					fail: function(res) {
						uni.showToast({
							title: "网络开小差了哦",
							icon: 'none'
						})
					}
				})
			},
			validateString(str) {
				// 判断是否包含空格或中文空格
				if (/\s|　/.test(str)) {
					return false;
				}
				// 判断是否只包含空格
				if (/^\s+$/.test(str)) {
					return false;
				}
				return true;
			},
			userEdit() {
				var that = this;
				var token = "";
				if (localStorage.getItem('userinfo')) {
					var userInfo = JSON.parse(localStorage.getItem('userinfo'));
					token = userInfo.token;
				}
				if (that.password != "") {
					if (!that.validatePassword(that.password)) {
						uni.showToast({
							title: "密码必须包含字母、数字和特殊符号，且长度必须大于8",
							icon: 'none',
							duration: 1000,
							position: 'bottom',
						});
						return false
					}
					if (that.password != that.repassword) {
						uni.showToast({
							title: "两次密码不一致",
							icon: 'none',
							duration: 1000,
							position: 'bottom',
						});
						return false
					}

				}
				if (that.isValidString(that.screenName)) {
					uni.showToast({
						title: "昵称不能包含空格",
						icon: 'none',
						duration: 1000,
						position: 'bottom',
					});
					return false
				}
				var data = {
					uid: that.uid,
					name: that.name,
					screenName: that.screenName,
					password: that.password,
					introduce: that.introduce,
					url: that.url,
				}
				if (that.avatarNew != '') {
					data.avatar = that.avatarNew;
				}
				uni.showLoading({
					title: "加载中"
				});
				that.$Net.request({

					url: that.$API.userEdit(),
					data: {
						"params": JSON.stringify(that.$API.removeObjectEmptyKey(data)),
						"token": token
					},
					header: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					method: "get",
					dataType: 'json',
					success: function(res) {
						//console.log(JSON.stringify(res))
						setTimeout(function() {
							uni.hideLoading();
						}, 1000);
						uni.showToast({
							title: res.data.msg,
							icon: 'none'
						})
						if (res.data.code == 1) {
							//保存用户信息
							if (that.password != "") {
								localStorage.removeItem('userinfo');
								localStorage.removeItem('token');
								var timer = setTimeout(function() {
									var styleIndex = that.styleIndex;
									uni.redirectTo({
										url: '/pages/home/' + styleIndex
									});
									clearTimeout('timer')
								}, 1000)
							} else {
								var userInfo = JSON.parse(localStorage.getItem('userinfo'));
								userInfo.screenName = that.screenName;
								userInfo.url = that.url;
								userInfo.introduce = that.introduce;
								if (that.avatarNew != '') {
									userInfo.avatar = that.avatarNew;
								}
								that.avatarNew = '';
								localStorage.setItem('userinfo', JSON.stringify(userInfo));
								//that.getCacheInfo();
							}

						}
					},
					fail: function(res) {
						setTimeout(function() {
							uni.hideLoading();
						}, 1000);
						uni.showToast({
							title: "网络开小差了哦",
							icon: 'none'
						})
						uni.stopPullDownRefresh()
					}
				})
			},
			toEmail() {
				var that = this;

				uni.navigateTo({
					url: '/pages/user/mailedit'
				});
			},
			toAddress() {
				var that = this;

				uni.navigateTo({
					url: '/pages/user/address'
				});
			},
			toPay() {
				var that = this;

				uni.navigateTo({
					url: '/pages/user/pay'
				});
			},
			toBg() {
				var that = this;

				uni.navigateTo({
					url: '/pages/user/userBg'
				});
			},
			toBind() {
				var that = this;

				uni.navigateTo({
					url: '/pages/user/userbind'
				});
			},
			toGravatar() {
				var that = this;
				that.hideModal();
				var url = "https://cn.gravatar.com/";
				// #ifdef APP-PLUS
				plus.runtime.openURL(url)
				// #endif
				// #ifdef H5
				window.open(url)
				// #endif
			},
			toAvatar() {
				// #ifdef APP-PLUS || H5
				const that = this;
				uni.navigateTo({
					url: "../../uni_modules/buuug7-img-cropper/pages/cropper",
					events: {
						imgCropped(event) {
							console.log(event);
						},
					},
				});
				// #endif
			},
			uploadAvatarToSever(path) {
				const uploadTask = uni.uploadFile({
					url: that.$API.upload(),
					filePath: path,
					//  header: {
					// "Content-Type": "multipart/form-data",
					// },
					name: 'file',
					formData: {
						'token': token
					},
					success: function(uploadFileRes) {
						setTimeout(function() {
							uni.hideLoading();
						}, 1000);
						var data = JSON.parse(uploadFileRes.data);
						//var data = uploadFileRes.data;
						if (data.code == 1) {
							// uni.showToast({
							// 	title: data.msg,
							// 	icon: 'none'
							// })
							that.avatar = data.data.url;
							that.avatarNew = data.data.url;
							localStorage.removeItem('toAvatar');
							that.userEdit();
							//console.log(that.avatar)
						} else {
							uni.showToast({
								title: "头像上传失败，请检查接口",
								icon: 'none'
							})
						}
					},
					fail: function() {
						setTimeout(function() {
							uni.hideLoading();
						}, 1000);
					}
				})
			},
			avatarUpload(data) {
				var that = this;
				var token = "";
				if (localStorage.getItem('userinfo')) {
					var userInfo = JSON.parse(localStorage.getItem('userinfo'));
					token = userInfo.token;
					token = userInfo.token;
				}
				// #ifdef APP-PLUS || H5
				base64ToPath(data)
					.then(path => {
						that.uploadAvatarToSever(path)
					})
					.catch(error => {
						console.error("失败" + error)
					})
				// #endif
				// #ifdef MP-WEIXIN
				const path = data.detail.avatarUrl
				that.uploadAvatarToSever(path)
				// #endif
			},
			isValidString(str) {
				return /\s/g.test(str);
			}
		}
	}
</script>

<style>
</style>
